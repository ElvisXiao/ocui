<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: fileView.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: fileView.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
@author Elvis
@class FileView
@classdesc CSV文件预览与标记
@example
* var fileView = new FileView({
    container: '#container',
    maxHeight: 400
})

*/

/**
@constructs FileView
@param {object} options 配置变量对象 - container为容器对象、canEdit：csv是否允许编辑状态、maxHeight：最大高度、heads：指定头部列
*/
var FileView = function(options){
    this.csv = require('./asset/csv');
    /**最外层Jquery对象*/
    this.ele = null;
    /**数据集合 */
    this._dataList = [];

    /**是否能编辑 */
    this.canEdit = true;

    /**容器最大高度，超过此高度后将出现滚动条 */
    this.maxHeight = 800;

    this.config = {
        container: 'body',
        canEdit: true,
        maxHeight: 800,
        heads: []
    };

    for(var key in options){
        if(this.config.hasOwnProperty(key)){
            this.config[key] = options[key];
        }
    }

    var self = this;

    self._render = function(){
        self.ele = $('&lt;div class="zUploader">&lt;/div>');
        var uploadList = $('&lt;div class="zUploaderList">&lt;/div>');
        uploadList.append(self._renderNoFile());
        self.ele.append(uploadList);
        self.ele.appendTo(self.config.container);
    }

    self._renderNoFile = function(){
        var div = $('&lt;div class="zUploaderNoFile" style="padding:15px 0 0 0;">&lt;/div>');
        div.append('&lt;span class="zUploaderFileBtn ">&lt;input type="file" accept=".csv" />&lt;span class="zUploaderBtnText">点击选择文件&lt;/span>&lt;/div>');
        div.append('&lt;p>或将文件拖到这里, 暂仅支持CSV格式&lt;/p>');

        return div;
    }

    self._bindEvent = function(){
        self.ele.on('change', '.zUploaderFileBtn input[type="file"]', function(){
            self._readFilesToTable(this.files[0]);
        });

        self.ele.find('.zUploaderNoFile')[0].addEventListener("drop", function(e){
            $(this).css('border', '3px dashed #e6e6e6');
            e.preventDefault();
            self._readFilesToTable(e.dataTransfer.files[0]);
        })
        self.ele.on('dragenter', '.zUploaderNoFile', function(e){
            e.preventDefault();
            $(this).css('border', '3px dashed #aaa');
        }).on('dragleave', '.zUploaderNoFile', function(e){
            e.preventDefault();
            $(this).css('border', '3px dashed #e6e6e6');
        });
        $(document).on({
            dragleave: function(e){e.preventDefault();},
            drop: function(e){e.preventDefault();},
            dragenter: function(e){e.preventDefault();},
            dragover: function(e){e.preventDefault();},
        })

        self.ele.on('blur', '.zFileTable tbody td input', function(){
            var val = this.value;
            var ele = $(this);
            var td = ele.parent();
            var index = td.attr('data-index');

            var indexArr = index.split(',');
            var i = indexArr[0];
            var j = indexArr[1];
            self._dataList[i][j] = val;
        })
    }

    //返回值：model数组
    self.readCsv = function(file, cb){
        var reader = new FileReader();
        reader.onload = function(e){
            $('input[type="file"]').replaceWith($('&lt;input type="file" accept=".csv">'));
            var content = reader.result;
            self._formatFileContent(content);
            cb();
        }

        reader.readAsText(file);
    }

    self._formatFileContent = function(content){
        var models = self.csv.parse(content);
        var firstItem = models[0];
        var keys = [];
        for(var key in firstItem){
            keys.push(key);
        }
        self._dataList = [];
        self._dataList.push(keys);
        for(var i = 0; i &lt; models.length; i++){
            var item = models[i];
            var datas = [];
            for(var key in item){
                datas.push(item[key]);
            }
            self._dataList.push(datas);
        }
    }

    //返回值：$table
    self._readFilesToTable = function(file){
        self.readCsv(file, function(){
            $('.zFileTableContainer').remove();
            var tableContainer = $('&lt;div class="zFileTableContainer">&lt;table class="zFileTable">&lt;/table>&lt;/div>');
            if(self.config.maxHeight){
                tableContainer.css('max-height', self.config.maxHeight + 'px');
            }
            var ret = tableContainer.find('.zFileTable');
            if(self._dataList &amp;&amp; self._dataList.length > 0){
                var keys = self._dataList[0];
                var keysLen = keys.length;
                var thead = $('&lt;thead>&lt;/thead>');
                var tbody = $('&lt;tbody>&lt;/tbody>');
                var theadTr = $('&lt;tr>&lt;th>&lt;/th>&lt;/tr>').appendTo(thead);
                for(var i = 0; i &lt; keysLen; i++){
                    theadTr.append('&lt;th>' + keys[i] + '&lt;/th>');
                }

                for(var i = 1; i &lt; self._dataList.length; i++){
                    var item = self._dataList[i];
                    var tr = $('&lt;tr>&lt;td>' + i + '&lt;/td>&lt;/tr>');
                    for(var j = 0; j &lt; keysLen; j++){
                        tr.append('&lt;td data-val="true", data-index="' + i + ',' + j + '">' + $.trim(item[j]) + '&lt;/td>');
                    }
                    tbody.append(tr);
                }
                ret.append(thead);
                ret.append(tbody);
            }
            var uploadList = self.ele.find('.zUploaderList');
            uploadList.find('.zFileTable').remove();
            tableContainer.appendTo(uploadList);

            self.setEditTable(ret);
        })
    }
    
    self.setEditTable = function(table){
        if(self.config.canEdit === true){
            table.find('tbody td[data-val]').each(function(){
                var td = $(this);
                var text = td.html();
                td.html('&lt;span class="tdSpan">' + text + '&lt;/span>&lt;input class="tdIpt" type="text" value="' + text + '" />');
            });           
        }
    }

    self.getDataList = function(){
        var models = [];
        if (!self._dataList || self._dataList.length === 0){
            return null;
        }

        var keys = self._dataList[0];
        if(self.config.heads &amp;&amp; self.config.heads.length > 0){
            if(self.config.heads.length > keys.length){
                self.config.heads = self.config.heads.slice(0, keys.length);
            }
            keys = keys.slice(self.config.heads.length);
            keys = self.config.heads.concat(keys);
        }
        var keyLength = keys.length;
        for (var i = 1; i &lt; self._dataList.length; i++){
            var line = self._dataList[i];
            var one = {};
            for (var j = 0; j &lt; keyLength; j++){
                one[keys[j]] = $.trim(line[j]);
            }
            models.push(one);
        }

        return models;
    }

    self.mark = function(msgList){
        var length = msgList.length;
        for(var i = 0; i &lt; length; i++){
            var msgItem = msgList[i];
            var dataIndex = msgItem.row + ',' + msgItem.col;
            var td = self.ele.find('tbody td[data-index="' + dataIndex + '"]');
            td.addClass('zFileTableMark').attr('title', msgItem.msg);
        }
    }

    self.clearMark = function(){
        self.ele.find('tbody .zFileTableMark').removeAttr('title').removeClass('zFileTableMark');
    }

    self._render();
    self._bindEvent();
}


module.exports = FileView;

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="oc.module_ajax.html">ajax</a></li><li><a href="oc.module_date.html">date</a></li><li><a href="oc.module_dialog.html">dialog</a></li></ul><h3>Classes</h3><ul><li><a href="FileView.html">FileView</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Tue Jun 02 2015 14:05:37 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
