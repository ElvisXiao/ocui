<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: table.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: table.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var toolsDojo = require('./toolsDojo');

/**
 * @param  {string} param -- url or array list 
 * @return {object}
 */
var Table = function() {
	this.pageNo = 1;    // 当前的页码数，默认为1
	this.pageSize = 10; //单页显示行数，默认值为10
    this.sortKey;
    this.sortUp;
    
    this.showPager = true; //是否显示分页信息
    this.hasNext; //是否有下一页---

	this.showSearchBox = false; // 是否显示搜索框 
    this.exportFile = '';
	this.showBtnExport = false; //是否显示导出按钮
    this.showCheckbox = false;

    this.total = null; // 用于服务器端数据获取------
    this.originDataList = null;
	this.dataList = null;  //原始数据保存区
    this.filterDataList = null;      //根据条件查询出来的所有数据保存区, 暂时不用
    this.pageData;        //当前页的数据
    this.tdDataList = null;
    this.filterTdDataList = null;
    
    this.ajaxCallback; //服务器端加载数据的回调函数
    this.afterLoad;   //数据重新加载后调用，一般在翻页，搜索后

    this.table = $('&lt;table class="table ocTable">&lt;/table>');
	//表头的配置对象
	this.headMapping = {
		id: {text: 'ID', width: 50, sort: true, },
        name: {text: '姓名', width: 100, sort: true, export: false},
        department: '部门',
        sex: '性别',
        param1: {text: '参数1', width: 100},
	};

	var self = this;

    self.load = function(dataList, ajaxTotal) {
        self.table.removeClass('zLoadingCover');
        if(typeof ajaxTotal === 'number') {
            self.total = ajaxTotal;
        }
        if(typeof ajaxTotal === 'boolean') {
            self.hasNext = ajaxTotal;
        }
        self.originDataList = $.extend(true, [], dataList);

        self.filterDataList = self.dataList = $.extend(true, [], dataList);

        var body = self._renderBody();
        
        self.table.find('tbody').replaceWith(body);
        if(self.showPager) {
            var foot = self._renderFoot();
            self.table.find('tfoot').replaceWith(foot);
        }
        else {
            self.table.find('tfoot').remove();
        }

        // self._buildTdData();
        self.filterDataList = self.dataList;
        
        self.afterLoad &amp;&amp; self.afterLoad();
    }

    self.loading = function() {
        self.dataList = self.filterDataList = null;
        self.table.find('tbody').html('&lt;tr>&lt;td colspan="100">&lt;i class="zLoadingIcon">&lt;/i> Loading ...&lt;/td>&lt;/tr>');
    }

	//build Table的Caption部分
	self._renderCaption = function() {
		var caption = $('&lt;caption>&lt;/caption>');
        
        if(this.showBtnExport) {
            caption.append('&lt;button type="text" class="btnExport btn btn-gray btn-sm fr" style="margin-bottom: 5px;">Export&lt;/button>');
        }
        if(this.showSearchBox) {
            caption.append('&lt;label class="form-inline w200">&lt;input type="text" class="searchBox form-control input-sm" placeholder="Search here ..." />&lt;/label>');
        }

        return caption;
	}
    
	//build Table的头部 -----
	self._renderHead = function() {
		var thead = $('&lt;thead>&lt;tr>&lt;/tr>&lt;/thead>');
		var tr = thead.find('tr');
        if(self.showCheckbox) {
            tr.append('&lt;th style="width: 40px">&lt;input class="cbxOcTable" type="checkbox" />&lt;/th>');
        }
		for(var key in self.headMapping) {
			var params = self.headMapping[key];
			var text = params.text;
            if(text === undefined) {
                text = key;
            }
            var th = $('&lt;th>' + text + '&lt;/th>');


            
            if(params.sort) {
            	th.attr('data-sort', key);
            }
            if(params.export === false) {
            	th.attr('data-export', false);
            }
            if(params.width) {
            	th.css('width', params.width + 'px');
            }
            if(params.title) {
                th.attr('title', params.title).append('&lt;i class="icon icon-info">&lt;/i>');
            }

            for(var paramKey in params) {
                if(params.hasOwnProperty(paramKey) &amp;&amp; ['sort', 'export', 'width', 'title'].indexOf(paramKey) === -1) {
                    th.attr(paramKey, params[paramKey]);
                }
            }

            tr.append(th);
		}

        return thead;
	}

    self._getDefault = function(val) {
        if(val === undefined || val === null) {
            return '';
        }
        return val;
    }
    
    self._getVal = function(model, key) {
        var arr = key.split('.');
        var tdVal = model[key];
        if(arr.length > 1) {
            tdVal = model;
            for(var i = 0; i &lt; arr.length; i++) {
                tdVal = tdVal[arr[i]];
                if(!tdVal) {
                    break;
                }
            }
        }
        
        return tdVal;
    }

	//build每一行的数据, 请根据实际情况复写----
	self.renderTr = function(model) {
		var tr = $('&lt;tr>&lt;/tr>');
        for(var key in self.headMapping) { 
            var arr = key.split('.');   //支持嵌套Model的render-----
            var tdVal = self._getVal(model, key);
            
            tr.append('&lt;td>' + self._getDefault(tdVal) + '&lt;/td>');
        }

        return tr;
	}
    
    self.filter = function(fn) {
        if(!fn || typeof fn !== 'function') {
            return;
        }

        self.filterDataList = self.dataList.filter(function(model) {
            return fn(model);
        })

        self.pageNo = 1;

        self._reloadBody();
        self._reloadFoot();
    }

    //filterData改变的情况下，需要更新td数据, 暂时不用
    self._buildTdData = function() {
        //让ui先更新，后处理数据----
        self.dataList = self.dataList.map(function(model) {
            self._setTrModel(model);
            return model;
        })
    }

    self._setTrModel = function(model) {
        var trModel = {};
        var tr = self.renderTr(model);
        var tds = tr.find('>td');
        var i = 0;
        for(var key in self.headMapping) {
            // var val = self._getVal(model, key);
            var val = $(tds[i]).text();
            // trModel[key] = val;

            if(/^[1-9][0-9]*(\.)?[0-9]*$/.test(val)) {
                val = parseFloat(val);
            }
            trModel[key] = val;

            i++;
        }

        model.trModel = trModel;
    }

    self._getValByMappingKey = function(model, key) {
        var tdVal = self._getVal(model, key);
        var text = self._getDefault(tdVal);
        return text;
    }

    self._getPageData = function() {
        if(self.total || typeof self.hasNext === 'boolean') {
            return self.dataList;
        }

        var start = self.pageSize * (self.pageNo - 1);
        var dataList = self.filterDataList;
        if(self.showPager) {
            var len = self.pageSize > dataList? dataList.length: self.pageSize;
            self.pageData = self.filterDataList.slice(start, len + start);
        }
        else {
            self.pageData = self.filterDataList;
        }
        
        return self.pageData;
    }

    self._renderBody = function() {
        var tbody = $('&lt;tbody>&lt;/tbody>');

        if(!self.filterDataList) {
            tbody.append('&lt;tr>&lt;td colspan="100">&lt;i class="zLoadingIcon">&lt;/i> Loading ...&lt;/td>&lt;/tr>');
            return tbody;
        }

        if(self.filterDataList.length) {
            self.pageData = self._getPageData();
            for(var i = 0; i &lt; self.pageData.length; i ++) {
                var model = self.pageData[i];
                var tr = self.renderTr(model);
                if(self.showCheckbox) {
                    tr.prepend('&lt;td>&lt;input type="checkbox" class="cbxOcTable">&lt;/td>');
                }
                tbody.append(tr);
            }
        }
        else {
            self.pageData = [];
            tbody.append('&lt;tr class="trEmpty">&lt;td colspan="100">No data&lt;/td>&lt;/tr>');
        }

        return tbody;
    }

    self._renderFoot = function() {
        if(self.pageNo) {
            self.pageNo = parseInt(self.pageNo);
        }
        else {
            self.pageNo = 1;
        }
        if(self.pageSize) {
            self.pageSize = parseInt(self.pageSize);
        }
        var tfoot = $('&lt;tfoot>&lt;tr>&lt;td colspan="100">&lt;form>&lt;nav>&lt;ul class="pagination">&lt;/ul>&lt;/nav>&lt;/form>&lt;/td>&lt;/tr>&lt;/tfoot>');
        var nav = tfoot.find('nav');
        var ul = tfoot.find('ul');
        
        if(!self.dataList || self.dataList.length == 0) {
            return tfoot;
        }

        if(self.hasNext !== undefined) { //只显示上一页，下一页的分页信息
            var prevLi = $('&lt;li>&lt;a href="#" title="Previous" data-page="' + (self.pageNo - 1) + '">Prev&lt;/a>&lt;/li>').appendTo(ul);
            var nextLi = $('&lt;li>&lt;a href="#" title="Next" data-page="' + (self.pageNo + 1) + '">Next&lt;/a>&lt;/li>').appendTo(ul);
            if(!self.hasNext) {
                nextLi.addClass('disabled');
            }
            if(self.pageNo == 1) {
                prevLi.addClass('disabled');
            }
            nav.parent().prepend('&lt;span class="form-inline pr" style="top: 5px">Current page ' + self.dataList.length + ' items, show &lt;input type="number" name="pageSize" class="form-control w40" min="1" max="2000" value="' + self.pageSize + '" title="1 ~ 2000之间的整数" /> rows each page.' );
        }
        else { //带页码的分页信息
            ul.append('&lt;li>&lt;a href="#" title="First" data-page="1">&amp;laquo;&lt;/a>&lt;/li>');
            ul.append('&lt;li>&lt;a href="#" title="Previous" data-page="' + (self.pageNo - 1) + '">‹&lt;/a>&lt;/li>');

            var total = self.total || self.filterDataList.length;
            var totalPage = parseInt(total / self.pageSize);
            if(totalPage * self.pageSize &lt; total) {
                totalPage ++;
            }

            var start = self.pageNo - 2;
            if(start &lt; 1) {
                start = 1;
            }

            var end = start + 4;
            if(end > totalPage) {
                end = totalPage;
                start = end - 4;
                start &lt; 1 &amp;&amp; (start = 1);
            }

            while(start &lt;= end) {
                var li = $('&lt;li>&lt;a href="#" data-page="' + start + '">' + start + '&lt;/a>&lt;/li>').appendTo(ul);
                if(start === self.pageNo) {
                    li.addClass('active');
                }
                start ++;
            }

            ul.append('&lt;li>&lt;a href="#" title="Next" data-page="' + (self.pageNo + 1) + '">›&lt;/a>&lt;/li>');
            ul.append('&lt;li>&lt;a href="#" title="Last" data-page="' + totalPage + '">&amp;raquo;&lt;/a>&lt;/li>');
            if(self.pageNo === 1) {
                ul.find('li:lt(2)').addClass('disabled');
            }
            if(self.pageNo === totalPage || totalPage === 0) {
                var last = ul.find('li:last-child').addClass('disabled');
                last.prev().addClass('disabled');
            }
            nav.parent().prepend('&lt;span class="form-inline pr" style="top: 5px">Total ' + total + ' rows in ' + totalPage + ' pages, show &lt;input type="number" name="pageSize" class="form-control w40" min="1" max="2000" value="' + self.pageSize + '" title="1 ~ 2000之间的整数" /> rows each page.' );
            nav.append('&lt;span class="form-inline">&lt;input type="number" name="pageNo" class="form-control w40" min="1" max="' + totalPage + '" />&lt;button class="btn btn-default" type="submit">GO&lt;/button>&lt;/span>');
        }
        

        return tfoot;
    }

    self._render = function() {

        var caption = self._renderCaption();
        var thead = self._renderHead();
        var tbody = self._renderBody();
        var foot = self._renderFoot();

        self.table.html('').off('click');
        self.table.append(caption);
        self.table.append(thead);
        self.table.append(tbody);
        self.table.append(foot);

        self._bindEvents();
    }

    self.placeAt = function(container) {
        var container = $(container);
        toolsDojo.destroyByNode(container[0]);
        container.html('');

        self._render();
        self.table.appendTo(container);
    }
    
    //根据搜索条件、重新加载tbody中的数据----
    self._reloadBody = function() {
        self.table.removeClass('zLoadingCover');
        var tbody = self.table.find('tbody').replaceWith(self._renderBody());

        self.afterLoad &amp;&amp; self.afterLoad();
    }

    self._reloadFoot = function() {
        self.table.find('tfoot').replaceWith(self._renderFoot());
    }

    //服务器端加载数据----------
    self._loadData = function () {
        if(!self.pageNo) {
            self.pageNo = 1;
        }
        // self.table.find('tbody').html('&lt;tr>&lt;td colspan="100">&lt;i class="zLoadingIcon mr5">&lt;/i>Loading...&lt;/td>&lt;/tr>');
        self.table.addClass('zLoadingCover');
        var params = {
            pageNo: self.pageNo,
            pageSize: self.pageSize
        }
        if(self.sortKey) {
            params.orderBy = self.sortKey;
            params.desc = self.sortUp? "asc": "desc";
        }
        
        self.ajaxCallback &amp;&amp; self.ajaxCallback(params, function(dataList) {
            self.dataList = self.filterDataList = dataList;
            if(!self.pageNo) {
                self.pageNo = 1;
            }
            self._reloadBody();
            self._reloadFoot();
        });
    }

    self.export = function(){
        var text = this._renderExport();
        var filename = self.exportFile;
        if(!filename) {
            filename = new Date().getTime();
        }
        else if(filename.indexOf('.csv') === -1) {
            filename += '.csv';
        }
        
        var blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        }
        else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // var tempForm = document.createElement("form");
        // tempForm.id = "tempForm1";
        // tempForm.method = "post";
        // tempForm.action = '/product/owerp/util/csv.jsp';
        // tempForm.charset = "UTF-8";
        // var fileNameInput = document.createElement("input");
        // fileNameInput.type="hidden";
        // fileNameInput.name = "name";
        // fileNameInput.value = this.exportFile + '.csv';
        // tempForm.appendChild(fileNameInput);
        // var contentInput = document.createElement("input");
        // contentInput.type="hidden";
        // contentInput.name = "content";
        // contentInput.value = text;
        // tempForm.appendChild(contentInput);
        // document.body.appendChild(tempForm);
        // tempForm.submit();
        // document.body.removeChild(tempForm);
    }

    self._renderExport = function(){  // 导出数据默认调用方法，可以重写.....
        var exportTable = "&lt;table>";
        var tHead = this._renderHead();
        tHead.find('.cbxOcTable').parents('th:eq(0)').remove();
        exportTable += tHead[0].outerHTML;
        var tbody = $('&lt;tbody>&lt;/tbody>');
        self.filterDataList.map(function(model) {
            var tr = self.renderTr(model);
            tbody.append(tr);
        })
        exportTable += tbody[0].outerHTML;
        exportTable += '&lt;/table>';
        table = $(exportTable);
        table.find('[data-export="false"]').each(function(){
            var index = $(this).index();
            table.find('thead tr th:eq(' + index + ')').remove();
            table.find('tbody tr').find('td:eq(' + index + ')').remove();
        })
        var text = table.html();
        text = text.replace(/(&lt;thead[^>]*>)|(&lt;tbody[^>]*>)|(&lt;\/thead>)|(&lt;\/tbody>)|(&lt;tr[^>]*>)/g, '');
        text = text.replace(/(&lt;th[^>]*>)|(&lt;td[^>]*>)/g, '\"');
        text = text.replace(/(&lt;\/th>)|(&lt;\/td>)/g, '\t\",');
        text = text.replace(/,&lt;\/tr>/g, '\n');
        text = text.replace(/(&lt;[^>]*>)|(&lt;\/[^>]*>)/g, "");  //去除别的html标签
        return text;
    }

    self._bindFootEvents = function() {
        self.table.on('click', 'tfoot .pagination li a', function(e) {
            e.preventDefault();
            var a = $(this);
            if(a.parent().hasClass('active') || a.parent().hasClass('disabled')) {
                return;
            }
            self.pageNo = parseInt(a.attr('data-page'));
            //服务器端加载数据--------
            if(self.total || typeof self.hasNext === 'boolean') {
                self._loadData();

                return;
            }

            self._reloadBody();
            self._reloadFoot();
        })
        .on('click', 'thead th[data-sort]', function() {
            if(!self.dataList) {
                return;
            }
            var th = $(this);
            th.parent().find('th').not(th).removeClass('sortUp').removeClass('sortDown');
            var key = th.attr('data-sort');
            var sortUp = true;

            if(th.hasClass('sortUp')) {
                th.removeClass('sortUp').addClass('sortDown');
                sortUp = false;
            }
            else{
                th.removeClass('sortDown').addClass('sortUp');
            }

            self.pageNo = 1;

            //服务器端加载数据--------
            if(self.total || typeof self.hasNext === 'boolean') {
                self.sortKey = key;
                self.sortUp = sortUp;
                self._loadData();

                return;
            }

            self.filterDataList.sort(function(a, b) {
                var valA, valB;
                if(a.trModel) {
                    valA = a.trModel[key];
                    valB = b.trModel[key];
                }
                else {
                    valA = self._getValByMappingKey(a, key);
                    valB = self._getValByMappingKey(b, key);
                }

                if(typeof valA === 'number') {
                    return sortUp? valA - valB : valB - valA;
                }

                return sortUp? valA.toString().localeCompare(valB) : valB.toString().localeCompare(valA); 
            })
            self._reloadBody();
        })
        .on('submit', 'tfoot form', function() {
            var form = self.table.find('tfoot form');
            self.pageSize = parseInt(form.find('input[name="pageSize"]').val());
            self.pageNo = parseInt(form.find('input[name="pageNo"]').val() || 1);

            //服务器端加载数据--------
            if(self.total || typeof self.hasNext === 'boolean') {
                self._loadData();

                return false;
            }

            self._reloadBody();
            self._reloadFoot();

            return false;
        })
    }

    //搜索匹配所有列
    self.search = function(searchStr) {
        if(!self.dataList || !self.dataList.length) {
            return;
        }
        if(!self.dataList[0].trModel) {
            self._buildTdData();
        }

        self.pageNo = 1;
        searchStr = (searchStr || '').toUpperCase();
        self.filterDataList = self.dataList.filter(function(model) {
            var ret = false;
            var trModel = model.trModel;
            for(var key in trModel) {
                if(trModel[key].toString().toUpperCase().indexOf(searchStr) !== -1) {
                    ret = true;
                    break;
                }
            }

            return ret;
        })

        self._reloadBody();
        self._reloadFoot();
    }

    self._bindEvents = function() {
        //search----
        self.table.off('input').on('input', 'caption .searchBox', function() {
            var searchStr = $.trim(this.value).toUpperCase();
            self.timer &amp;&amp; clearTimeout(self.timer);
            self.timer = setTimeout(function(){
                self.search(searchStr);
            }, 500);
        })
        .off('click')
        .on('click', 'thead input:checkbox.cbxOcTable', function() {
            var checked = this.checked;
            self.table.find('tbody input:checkbox.cbxOcTable').each(function() {
                $(this).prop('checked', checked).change();
            })
        })
        .on('click', 'tbody input:checkbox.cbxOcTable', function() {
            self.table.find('thead input:checkbox.cbxOcTable').prop('checked', false).change();
        })
        .on('click', 'caption .btnExport', function() {
            self.export();
        })

        self._bindFootEvents();
    }
}


module.exports = Table;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="oc.module_ajax.html">ajax</a></li><li><a href="oc.module_date.html">date</a></li><li><a href="oc.module_dialog.html">dialog</a></li><li><a href="oc.module_localStorage.html">localStorage</a></li><li><a href="oc.module_ui.html">ui</a></li></ul><h3>Classes</h3><ul><li><a href="dialog.html">dialog</a></li><li><a href="ImageCrop.html">ImageCrop</a></li><li><a href="Sidebar.html">Sidebar</a></li><li><a href="Tree.html">Tree</a></li><li><a href="Uploader.html">Uploader</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_dataList">_dataList</a></li><li><a href="global.html#canEdit">canEdit</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#csv">csv</a></li><li><a href="global.html#ele">ele</a></li><li><a href="global.html#maxHeight">maxHeight</a></li><li><a href="global.html#Table">Table</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Nov 08 2017 16:27:33 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
